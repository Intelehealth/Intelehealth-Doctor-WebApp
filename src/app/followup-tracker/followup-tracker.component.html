<div class="container-fluid">
    <div class="row">
      <div class="col-md-12 p-0">
        <mat-accordion class="intel-accordion-con" multi>
  
          <mat-expansion-panel [expanded]="true" data-test-id="matExpCompleted">
            <mat-expansion-panel-header data-test-id="matExpHeaderCompleted">
              <mat-panel-title>
                <div class="intel-accordion-title">
                  <img src="assets/svgs/follow-up-tracker.svg" alt="" width="44px">
                  <h6 class="mb-0 ml-2">{{'Follow-up Log'|translate}} ({{doctorFollowpCount}})</h6>
                  <mat-icon class="info_icon" aria-hidden="false" aria-label="help icon" 
                  matTooltip="{{'Visits that follow-up provided by you'|translate}}" matTooltipPosition="right"
                   data-test-id="matIcoHelpCompleted">help_outline</mat-icon>
                  <div class="input-group input-group1 search-bar ml-auto mr-2" (click)="$event.stopPropagation();">
                    <div class="input-group-append1" [matMenuTriggerFor]="dateFilter">
                      <span class="input-group-text" id="basic-addon1">
                        <img src="assets/svgs/filter.svg" alt="" width="15px" height="24px">
                        {{'Filter'| translate}}
                      </span>
                    </div>
                  </div>
                </div>
              </mat-panel-title>
            </mat-expansion-panel-header>
  
            <div class="mat-elevation-z8">
              <table mat-table [dataSource]="dataSource">
  
                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef> {{'Patient'|translate}} </th>
                  <td mat-cell *matCellDef="let element;let j=index;" [attr.data-test-id]="'compPatient'+j">
                    <div class="d-flex align-items-center">
                      <img src="{{ baseUrl + '/personimage/' + element.person.uuid }}" alt="" width="32px" height="32px" style="border-radius: 50%;">
                      <span class="font-bold ml-2">{{element.patient_name.given_name}} {{element.patient_name?.middle_name ? element.patient_name?.middle_name+" " : ""}}{{element.patient_name.family_name}} ({{(element.person.gender) | translate}})</span>
                    </div>
                  </td>
                </ng-container>
  
                <!-- Age Column -->
                <ng-container matColumnDef="age">
                  <th mat-header-cell *matHeaderCellDef> {{'Age'|translate}} </th>
                  <td mat-cell *matCellDef="let element;let j=index;" [attr.data-test-id]="'compAge'+j"> {{element.person.age}} {{'y'|translate}} </td>
                </ng-container>
  
                <!-- Chief complaint Column -->
                <ng-container matColumnDef="cheif_complaint">
                  <th mat-header-cell *matHeaderCellDef> {{'Chief Complaint'|translate}} </th>
                  <td mat-cell *matCellDef="let element;let j=index;" [attr.data-test-id]="'compComplaint'+j"> {{element.cheif_complaint}} </td>
                </ng-container>

                  <!-- Doctor Column -->
                  <ng-container matColumnDef="doctor_name">
                    <th mat-header-cell *matHeaderCellDef> {{'Doctor'|translate}} </th>
                    <td mat-cell *matCellDef="let element;let j=index;" [attr.data-test-id]="'compCreated'+j"> {{element.encounter_provider}} </td>
                  </ng-container>
    

                <!-- FollowUp date Column -->
                <ng-container matColumnDef="followUp_date">
                  <th mat-header-cell *matHeaderCellDef> {{'Follow-up date'|translate}} </th>
                  <td mat-cell *matCellDef="let element;let j=index;" [attr.data-test-id]="'compLocation'+j"> {{element.followup_date}} </td>
                </ng-container>
  
                <!-- Patient verdict Column -->
                <ng-container matColumnDef="patient_verdict">
                  <th mat-header-cell *matHeaderCellDef> {{'Patient Verdict'|translate}} </th>
                  <td mat-cell *matCellDef="let element;let j=index;" [attr.data-test-id]="'compPresSent'+j">
                      <span class="ml-2">{{element?.patient_verdict ? element?.patient_verdict : 'Follow-up pending'}}</span>
                  </td>
                </ng-container>
                
                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" [attr.colspan]="displayedColumns.length">
                    {{'No data to display.'|translate}}
                  </td>
                </tr>
  
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; let x=index; columns: displayedColumns;" [attr.data-test-id]="'comp'+x" [routerLink]="['/dashboard/visit-summary', row?.uuid]" ></tr>
              </table>
  
              <mat-paginator #tempPaginator hidePageSize [pageSizeOptions]="[5, 10, 20]" hidden aria-label="Select page of periodic elements"></mat-paginator>
              <mat-paginator #completedPaginator hidePageSize [pageSizeOptions]="[5, 10, 20]"
              [length]="doctorFollowpCount" [pageIndex]="pageIndex" [pageSize]="pageSize" (page)="pageEvent = getData($event)" aria-label="Select page of periodic elements" data-test-id="matPaginatorCompleted">
              </mat-paginator>
            </div>
  
          </mat-expansion-panel>
        </mat-accordion>
      </div>
    </div>
  </div>
  
  <div class="d-flex align-items-center justify-content-end">
    <mat-menu #dateFilter="matMenu" [hasBackdrop]="false" class="menu1">
      <div (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
        <button mat-icon-button  class="date-btn mt-2" [ngClass]="showRange || showAllVisits  ? 'bg-color-white': 'bg-color-lightGray'"
         (click)="showDate = true; showRange = false; showAllVisits = false; fromDate=null; toDate=null">Date</button>
        <button mat-icon-button class="date-btn mt-2 mr-2" [ngClass]="showDate || showAllVisits ? 'bg-color-white': 'bg-color-lightGray'"
         (click)="showRange = true; showDate = false;  showAllVisits = false; fromDate=null; toDate=null">Range</button>
        <button mat-icon-button  class="range-btn mt-2" [ngClass]="showRange || showDate  ? 'bg-color-white': 'bg-color-lightGray'" 
         (click)="showAllVisits = true; showDate = false; showRange = false; fromDate=null; toDate=null;">All</button>
        <div *ngIf="showDate" class="date-filter">
          <div class="input-field-group">
            <input class="mt-4" type="date" [(ngModel)]="fromDate" data-test-id="etExpiryDateAddLicense">
          </div>
          <div class="actions-btn-wrap d-flex align-items-center ml-4 mt-4 mb-2">
            <button class="action-btn white-btn mr-2" type="button" (click)="resetFilter()" data-test-id="btnCancel">Reset</button>
            <button class="action-btn blue-btn" type="button" [disabled]="(showDate && !fromDate)"
                      (click)="applyDateFilter(showAllVisits)" data-test-id="btnSubmit">Apply</button>
          </div>
        </div>
        <div *ngIf="showRange" class="date-filter">
          <div class="input-field-group">
            <label class="mt-4">From</label>
            <input type="date" [(ngModel)]="fromDate" data-test-id="etExpiryDateAddLicense">
          </div> 
          <div class="input-field-group">
            <label>To</label>
            <input type="date" [(ngModel)]="toDate" data-test-id="etExpiryDateAddLicense">
          </div>
          <div class="actions-btn-wrap d-flex align-items-center ml-4 mt-4 mb-2">
            <button class="action-btn white-btn mr-2 fw-bold" type="button" (click)="resetFilter()" data-test-id="btnCancel">Reset</button>
            <button class="action-btn blue-btn" type="button" [disabled]="(showRange && (!fromDate || !toDate) || (fromDate > toDate))" 
            (click)="applyDateFilter(showAllVisits)" data-test-id="btnSubmit">Apply</button>
          </div>
        </div>
        <div *ngIf="showAllVisits" class="date-filter">
          <div class="form-check ml-4 mt-4 fw-bold">
            <input class="form-check-input" type="checkbox" [checked]="selectAll" (change)="selectAll = !selectAll" id="flexCheckIndeterminate">
            <label class="form-check-label" for="flexCheckIndeterminate">
              All Doctor's Follow-up Log
            </label>
          </div>
          <div class="actions-btn-wrap d-flex align-items-center ml-4 mt-4 mb-2">
            <button class="action-btn white-btn mr-2" type="button" (click)="resetFilter()" data-test-id="btnCancel">Reset</button>
            <button class="action-btn blue-btn" type="button"
                      (click)="applyDateFilter(showAllVisits)" [disabled]="!selectAll" data-test-id="btnSubmit">Apply</button>
          </div>
        </div>
      </div>
    </mat-menu>
  </div>